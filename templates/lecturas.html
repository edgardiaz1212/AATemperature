{% extends 'base.html' %}

{% block title %}Registro de Lecturas - Monitoreo AC{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5"><i class="fas fa-thermometer-half me-2"></i>Registro de Lecturas</h1>
        <p class="text-muted">Registra las mediciones de temperatura y humedad de los aires acondicionados</p>
    </div>
</div>

<div class="row">
    <div class="col-md-5 mb-4">
        <!-- Formulario para agregar lectura -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0"><i class="fas fa-plus-circle me-2"></i>Nueva Lectura</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('lecturas') }}">
                    <div class="mb-3">
                        <label for="aire_id" class="form-label">Aire Acondicionado</label>
                        <select class="form-select" id="aire_id" name="aire_id" required>
                            <option value="" disabled selected>Selecciona un aire acondicionado</option>
                            {% for _, row in aires.iterrows() %}
                            <option value="{{ row['id'] }}">{{ row['nombre'] }} ({{ row['ubicacion'] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fecha" name="fecha" value="{{ now().strftime('%Y-%m-%d') }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="hora" class="form-label">Hora</label>
                            <select class="form-select" id="hora" name="hora" required>
                                <option value="02:00:00">2:00 AM</option>
                                <option value="06:00:00">6:00 AM</option>
                                <option value="09:00:00">9:00 AM</option>
                                <option value="12:00:00">12:00 PM</option>
                                <option value="15:00:00">3:00 PM</option>
                                <option value="18:00:00">6:00 PM</option>
                                <option value="22:00:00">10:00 PM</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="temperatura" class="form-label">Temperatura (°C)</label>
                            <input type="number" class="form-control" id="temperatura" name="temperatura" step="0.1" min="-10" max="50" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="humedad" class="form-label">Humedad (%)</label>
                            <input type="number" class="form-control" id="humedad" name="humedad" step="0.1" min="0" max="100" required>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Registrar Lectura
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-7">
        <!-- Tabla de lecturas registradas -->
        <div class="card shadow">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Últimas Lecturas Registradas</h5>
                    <div>
                        <select id="filtroAire" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                            <option value="todos">Todos los aires</option>
                            {% for _, row in aires.iterrows() %}
                            <option value="{{ row['id'] }}">{{ row['nombre'] }}</option>
                            {% endfor %}
                        </select>
                        <button id="btnFiltrar" class="btn btn-sm btn-primary ms-2">
                            <i class="fas fa-filter me-1"></i>Filtrar
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tableLecturas" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Aire</th>
                                <th>Fecha y Hora</th>
                                <th>Temperatura</th>
                                <th>Humedad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se llenará con JavaScript -->
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul id="tablePagination" class="pagination justify-content-center">
                        <!-- Paginación con JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar esta lectura? Esta acción no se puede deshacer.</p>
                <p id="deleteModalDetails" class="fw-bold"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">
                    <i class="fas fa-trash-alt me-2"></i>Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let allLecturas = [];
    let filteredLecturas = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let deleteId = null;
    
    $(document).ready(function() {
        // Inicializar con la hora actual
        const now = new Date();
        let currentHour = now.getHours();
        let selectedHour = "15:00:00"; // Default a 3:00 PM
        
        if (currentHour < 6) selectedHour = "02:00:00";
        else if (currentHour < 9) selectedHour = "06:00:00";
        else if (currentHour < 12) selectedHour = "09:00:00";
        else if (currentHour < 15) selectedHour = "12:00:00";
        else if (currentHour < 18) selectedHour = "15:00:00";
        else if (currentHour < 22) selectedHour = "18:00:00";
        else selectedHour = "22:00:00";
        
        $("#hora").val(selectedHour);
        
        // Cargar datos
        cargarLecturas();
        
        // Evento para el botón de filtrar
        $('#btnFiltrar').click(function() {
            filtrarLecturas();
        });
        
        // Modal de confirmación para eliminar
        $('#deleteModal').on('show.bs.modal', function(event) {
            const button = $(event.relatedTarget);
            deleteId = button.data('id');
            const details = button.data('details');
            $('#deleteModalDetails').text(details);
        });
        
        // Botón para confirmar eliminación
        $('#btnConfirmDelete').click(function() {
            if (deleteId) {
                eliminarLectura(deleteId);
            }
        });
    });
    
    function cargarLecturas() {
        $.getJSON('/api/lecturas', function(data) {
            allLecturas = data;
            filtrarLecturas();
        });
    }
    
    function filtrarLecturas() {
        const aireId = $('#filtroAire').val();
        
        if (aireId === 'todos') {
            filteredLecturas = [...allLecturas];
        } else {
            filteredLecturas = allLecturas.filter(l => l.aire_id == aireId);
        }
        
        // Ordenar por fecha descendente
        filteredLecturas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        currentPage = 1;
        renderizarTabla();
    }
    
    function renderizarTabla() {
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedLecturas = filteredLecturas.slice(startIndex, endIndex);
        
        const tbody = $('#tableLecturas tbody');
        tbody.empty();
        
        if (paginatedLecturas.length === 0) {
            tbody.html('<tr><td colspan="6" class="text-center">No hay lecturas registradas.</td></tr>');
            $('#tablePagination').empty();
            return;
        }
        
        // Cargar nombres de aires
        $.getJSON('/api/aires', function(aires) {
            const airesMap = {};
            aires.forEach(a => { airesMap[a.id] = a.nombre; });
            
            paginatedLecturas.forEach(l => {
                const fecha = new Date(l.fecha);
                const fechaFormateada = fecha.toLocaleDateString('es-ES') + ' ' + fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                const row = `
                <tr>
                    <td>${l.id}</td>
                    <td>${airesMap[l.aire_id] || 'Aire ' + l.aire_id}</td>
                    <td>${fechaFormateada}</td>
                    <td>${l.temperatura}°C</td>
                    <td>${l.humedad}%</td>
                    <td>
                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" 
                                data-id="${l.id}" data-details="ID: ${l.id} - ${fechaFormateada}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                `;
                tbody.append(row);
            });
            
            // Renderizar paginación
            renderizarPaginacion();
        });
    }
    
    function renderizarPaginacion() {
        const totalPages = Math.ceil(filteredLecturas.length / rowsPerPage);
        const pagination = $('#tablePagination');
        pagination.empty();
        
        if (totalPages <= 1) return;
        
        // Botón Anterior
        pagination.append(`
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" aria-label="Previous" data-page="${currentPage - 1}">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
        `);
        
        // Botones de página
        for (let i = 1; i <= totalPages; i++) {
            pagination.append(`
                <li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `);
        }
        
        // Botón Siguiente
        pagination.append(`
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" aria-label="Next" data-page="${currentPage + 1}">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        `);
        
        // Evento para los enlaces de paginación
        $('.page-link').click(function(e) {
            e.preventDefault();
            const page = $(this).data('page');
            if (page && page >= 1 && page <= totalPages) {
                currentPage = page;
                renderizarTabla();
            }
        });
    }
    
    function eliminarLectura(id) {
        $.ajax({
            url: `/api/lecturas/${id}`,
            type: 'DELETE',
            success: function(result) {
                if (result.success) {
                    $('#deleteModal').modal('hide');
                    // Mostrar mensaje de éxito
                    $('<div class="alert alert-success alert-dismissible fade show" role="alert">')
                        .text('Lectura eliminada exitosamente')
                        .append('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>')
                        .prependTo('.container-fluid');
                    
                    // Recargar lecturas
                    cargarLecturas();
                } else {
                    alert('Error al eliminar la lectura');
                }
            },
            error: function() {
                alert('Error al conectar con el servidor');
            }
        });
    }
</script>
{% endblock %}